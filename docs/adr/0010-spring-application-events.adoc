= ADR 0010: Spring Application Events for Service Decoupling

== Status

Accepted

== Context

`LibraryManagementService` had direct dependencies on `DirectoryWatchingService` and `StreamingService` for side effects during library add/remove/scan. This created a circular dependency masked by `@Lazy`.

== Decision

Use Spring Application Events to decouple side effects from core operations.

* `LibraryManagementService` publishes `LibraryAddedEvent`, `LibraryRemovedEvent`, `ScanCompletedEvent`
* Listeners use `@EventListener` (non-transactional publishers) or `@TransactionalEventListener(AFTER_COMMIT)` (transactional publishers)
* Events are records in `services.library.events`, carrying only IDs and paths

== Consequences

* Circular dependency eliminated -- `@Lazy` removed
* Side effects are transactionally safe via `AFTER_COMMIT`
* New reactions require only a new listener (Open/Closed Principle)
* Event flow is less explicit than direct calls -- mitigated by naming conventions and `events` package
* Provides a clean path for UI push notifications (e.g. refreshing when a library is added or media is discovered) by subscribing to existing events
* Testing: `CapturingEventPublisher` for publishers; direct invocation for listeners
